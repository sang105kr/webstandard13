<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
    />
    <title>간단한 지도 표시하기</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=uhq6cts1yx&callback=main"></script>
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=0d19dafd2380499ec9c17a01cf58170b&libraries=services,clusterer,drawing"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      .wrap {
        position:relative;
      }

      #search{
        display: flex;
        justify-content: space-between;
        position:absolute;
        top:50px;
        left:50px;
        padding:7px;
        background-color: #fff;
        border: 1px solid #000;
        width:270px;
        font-size: 0.8rem;
        font-weight: bold;
      }
      #search button {
        font: inherit;
      }
      #whereAmI {
        font-size: 0.8rem;
        border-radius: 5%;
        background-color: yellow;
      }
      
    </style>
  </head>
  <body>
    <div class="wrap">
      <div id="map" style="width: 100vw; height: 100vh"></div>
      <div id="search">
        <label for="">검색어</label><input id='keyword' type="text"><button id="searchBtn">검색</button>
      </div>
    </div>
    <script>

      // 장소 검색 객체를 생성합니다
      const ps = new kakao.maps.services.Places(); 

      // 키워드로 장소를 검색합니다
      // ps.keywordSearch('공업탑', placesSearchCB); 

      // 키워드 검색 완료 시 호출되는 콜백함수 입니다
      function placesSearchCB (data, status, pagination) {
          console.dir(data);
          console.log(status)
          console.dir(pagination);
          if (status === kakao.maps.services.Status.OK) {

              // // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
              // // LatLngBounds 객체에 좌표를 추가합니다
              // var bounds = new kakao.maps.LatLngBounds();

              for (var i=0; i<data.length; i++) {
                  const marker = makeMarker(window.mymap, data[i].y, data[i].x)
                  // displayMarker(data[i]);    
                  // bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
              }       

              // // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
              // map.setBounds(bounds);
          } 
      }

      searchBtn.addEventListener('click',e=>{
        alert(keyword.value);
        // 키워드로 장소를 검색합니다
        ps.keywordSearch(keyword.value, placesSearchCB); 
      },false);

      // 위치 정보를 가져오는 함수를 Promise로 래핑
      function getCurrentPosition() {
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
      }

      // 지도 초기화 함수
      function initializeMap(lat, lng) {
        const mapOptions = {
          center: new N.LatLng(lat, lng),
          zoom: 15,
        };
        return new N.Map('map', mapOptions);
      }

      // 마커 생성 함수
      function makeMarker(map, lat, lng) {
        return new naver.maps.Marker({
          position: new naver.maps.LatLng(lat, lng),
          map: map,
        });
      }

      //정보창 내용 생성 함수
      function generateInfoWindowContent() {
        return `<div id='whereAmI'>
                  <p><b>내위치</b></p>
                  <p><a href='https://www.ulsankh.com/'>KH인재교육원</a></p>
                </div>`;
      }

      // 정보창 열기/닫기 토글 함수
      function toggleInfoWindow(map, marker, infowindow) {
        if (infowindow.getMap()) {
          infowindow.close();
        } else {
          infowindow.open(map, marker);
        }
      }

      //정보창 설정 함수
      function setupInfoWindow(map, marker, lat, lng) {
        const contentString = generateInfoWindowContent();

        //정보창
        const infowindow = new naver.maps.InfoWindow({
          content: contentString,
        });

        //마커 클릭 이벤트 리스너 추가
        naver.maps.Event.addListener(marker, 'click', function (e) {
          toggleInfoWindow(map, marker, infowindow);
        });

        infowindow.open(map, marker);
      }

      // 위치 정보를 가져오는 async함수
      async function fetchLocation() {
        try {
          const position = await getCurrentPosition();
          const { latitude: lat, longitude: lng } = position.coords;
          console.log(`위도:${lat}, 경도:${lng}`);

          //지도 초기화
          const map = initializeMap(lat, lng);
          window.mymap = map;
          

          //내위치 마커표시
          const marker = makeMarker(map, lat, lng);

          //정보창 설정
          setupInfoWindow(map, marker, lat, lng);

        } catch (err) {
          console.error('위치 정보를 가져오기 실패!', err);
        }
      }

      function main() {
        fetchLocation();
      }

      window.navermap_authFailure = () => {
        // 인증 실패 시 처리 코드 작성
        alert('인증실패');
      };
    </script>
  </body>
</html>
